<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        .container-card {
            @apply bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl mx-auto my-10;
        }
        .btn-primary {
            @apply bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out font-medium shadow-md;
        }
        .btn-danger {
            @apply bg-red-600 text-white px-4 py-1 rounded-lg hover:bg-red-700 transition duration-300 ease-in-out text-sm;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div class="container-card">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-900">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á üéôÔ∏è</h1>
        <p class="text-center text-gray-600 mb-8">
            ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
        </p>

        <!-- Loading and Error Messages -->
        <div id="loading" class="hidden flex justify-center items-center mb-4 p-3 bg-blue-100 text-blue-800 rounded-lg">
            <div class="loading-spinner mr-3"></div>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
        </div>
        <div id="message" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

        <!-- Authentication Status -->
        <div id="authStatus" class="text-center text-sm text-gray-500 mb-4">
            <span id="userIdDisplay"></span>
        </div>

        <hr class="my-8 border-t-2 border-gray-200">

        <!-- Search Section -->
        <div class="mb-8 p-6 bg-purple-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-purple-800">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="email" id="searchEmail" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ E-mail (‡πÄ‡∏ä‡πà‡∏ô user@example.com)" class="input-field">
                <input type="date" id="searchDate" class="input-field">
            </div>
            <div class="flex justify-center">
                <button id="searchButton" class="btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
        </div>

        <!-- Search Results Section -->
        <div class="p-6 bg-indigo-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-indigo-800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h2>
            <div id="searchResultsContainer" class="space-y-3">
                <p class="text-gray-500" id="noSearchResultsMessage">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤.</p>
                <!-- Search results will be listed here -->
            </div>
        </div>

        <hr class="my-8 border-t-2 border-gray-200">

        <!-- Files from 'submissions_part1' Section -->
        <div class="p-6 bg-green-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-green-800">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <div id="submissionPart1FilesContainer" class="space-y-3">
                <p class="text-gray-500" id="noSubmissionPart1FilesMessage">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á.</p>
                <!-- Files from submissions_part1 will be listed here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Initialize Firebase variables
        let app;
        let auth;
        let db;
        let storage;
        let currentUserId = null;
        let isAuthReady = false; // Flag to indicate if auth state has been checked
        let allSubmissionFiles = []; // To store all files for client-side filtering

        // DOM elements
        const loadingElement = document.getElementById('loading');
        const messageElement = document.getElementById('message');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Submissions_part1 Section DOM
        const submissionPart1FilesContainer = document.getElementById('submissionPart1FilesContainer');
        const noSubmissionPart1FilesMessage = document.getElementById('noSubmissionPart1FilesMessage');

        // Search Section DOM
        const searchEmailInput = document.getElementById('searchEmail');
        const searchDateInput = document.getElementById('searchDate');
        const searchButton = document.getElementById('searchButton');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const noSearchResultsMessage = document.getElementById('noSearchResultsMessage');

        // Display message function
        function showMessage(msg, type = 'info') {
            messageElement.textContent = msg;
            messageElement.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-blue-100', 'text-blue-800');
            if (type === 'error') {
                messageElement.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                messageElement.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'warning') {
                messageElement.classList.add('bg-yellow-100', 'text-yellow-800');
            } else { // info
                messageElement.classList.add('bg-blue-100', 'text-blue-800');
            }
            messageElement.classList.remove('hidden');
        }

        // Hide message function
        function hideMessage() {
            messageElement.classList.add('hidden');
        }

        // Show loading spinner
        function showLoading() {
            loadingElement.classList.remove('hidden');
        }

        // Hide loading spinner
        function hideLoading() {
            loadingElement.classList.add('hidden');
        }

        // Helper to format Firestore Timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            if (timestamp.toDate) { // Check if it's a Firestore Timestamp object
                const date = timestamp.toDate();
                return date.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
            }
            // Fallback for other date formats if necessary
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) return 'N/A'; // Invalid date
            return date.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
        }

        // Render file list (for both main display and search results)
        function renderFiles(container, files, noFilesMessageElement) {
            container.innerHTML = ''; // Clear previous content
            if (files.length === 0) {
                noFilesMessageElement.classList.remove('hidden');
            } else {
                noFilesMessageElement.classList.add('hidden');
                files.forEach((file) => {
                    const data = file.data;
                    const documentId = file.id;

                    // Prioritize 'question' or a generic title if 'text' is missing
                    const displayTitle = data.question || data.text || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢';
                    const displayEmail = data.email || '‡πÑ‡∏°‡πà‡∏°‡∏µ E-mail';
                    const displayTimestamp = formatTimestamp(data.timestamp);
                    const audioUrl = data.audioUrl;

                    if (audioUrl) {
                        const fileItem = document.createElement('div');
                        fileItem.classList.add('flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'justify-between', 'p-4', 'bg-white', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                        fileItem.innerHTML = `
                            <div class="flex-grow mb-2 sm:mb-0">
                                <p class="text-gray-900 font-semibold">${displayTitle}</p>
                                <p class="text-sm text-gray-700"><strong>E-mail:</strong> ${displayEmail}</p>
                                <p class="text-sm text-gray-700"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á:</strong> ${displayTimestamp}</p>
                            </div>
                            <div class="flex space-x-2 flex-shrink-0">
                                <a href="${audioUrl}" target="_blank" download="${displayTitle}.mp4" class="btn-primary">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
                                <button data-doc-id="${documentId}" data-audio-url="${audioUrl}" class="btn-danger delete-submission-btn">‡∏•‡∏ö</button>
                            </div>
                        `;
                        container.appendChild(fileItem);
                    }
                });
            }
        }

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            showLoading();
            try {
                // *** Firebase Configuration ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
                // ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase Console -> Project settings (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏ü‡∏∑‡∏≠‡∏á) -> General -> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà "Your apps"
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Web app ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì -> ‡∏Ñ‡∏•‡∏¥‡∏Å "Config"
                const firebaseConfig = {
                  apiKey: "AIzaSyA4OrZERUoxWPiShCEWVvz1MK9cYGO3_K8",
                  authDomain: "new-record-3ccd6.firebaseapp.com",
                  databaseURL: "https://new-record-3ccd6-default-rtdb.firebaseio.com",
                  projectId: "new-record-3ccd6",
                  storageBucket: "new-record-3ccd6.firebasestorage.app",
                  messagingSenderId: "1065863160189",
                  appId: "1:1065863160189:web:25313e55b0733f5e126c14",
                  measurementId: "G-JW6N2HYR58"
                };
                // ******************************************************

                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration is missing or empty. Please update firebaseConfig with your project details.");
                }

                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ID: ${currentUserId}`;
                        console.log("Firebase initialized and user authenticated:", currentUserId);
                        // Once authenticated, load all files from submissions_part1
                        await fetchSubmissionPart1Files();
                        hideLoading();
                        isAuthReady = true;
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
                        console.log("User not authenticated, signing in anonymously.");
                        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub Pages ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Canvas ‡∏à‡∏∞‡πÉ‡∏ä‡πâ signInAnonymously() ‡πÄ‡∏™‡∏°‡∏≠
                        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å __initial_auth_token ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
                        await signInAnonymously(auth);
                        hideLoading();
                        isAuthReady = true;
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or during authentication:", error);
                showMessage(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase: ${error.message}`, 'error');
                hideLoading();
            }
        }

        // Function to fetch and display files from 'submissions_part1'
        async function fetchSubmissionPart1Files() {
            if (!isAuthReady || !currentUserId) {
                console.log("Auth not ready or user not logged in for fetching submissions_part1 files.");
                return;
            }

            showLoading();
            allSubmissionFiles = []; // Clear previous data
            try {
                // Query the 'submissions_part1' collection
                const q = collection(db, 'submissions_part1');
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    querySnapshot.forEach((doc) => {
                        allSubmissionFiles.push({ id: doc.id, data: doc.data() });
                    });
                }
                renderFiles(submissionPart1FilesContainer, allSubmissionFiles, noSubmissionPart1FilesMessage);
            } catch (error) {
                console.error("Error fetching files from submissions_part1:", error);
                showMessage(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Function to delete a file from 'submissions_part1'
        async function deleteSubmissionPart1File(docId, audioUrl) {
            // Using browser's confirm, replace with custom modal if needed
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å Firestore ‡πÅ‡∏•‡∏∞‡∏à‡∏≤‡∏Å Storage (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ)?')) {
                return;
            }

            if (!isAuthReady || !currentUserId) {
                showMessage('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå', 'error');
                return;
            }

            showLoading();
            try {
                // Attempt to delete from Firebase Storage
                // WARNING: This assumes audioUrl is the storage path relative to the bucket root.
                // If your Storage rules don't allow writing/deleting at this path for the current user,
                // this operation will fail, but the Firestore document will still be deleted.
                try {
                    // Extract path from full download URL if it's a typical Firebase Storage URL
                    // Example: https://firebasestorage.googleapis.com/v0/b/project.appspot.com/o/audios%2Fuid%2Ffilename.mp4?...
                    const url = new URL(audioUrl);
                    const pathWithoutToken = url.pathname.split('/o/')[1]; // Get 'audios%2Fuid%2Ffilename.mp4'
                    const decodedPath = decodeURIComponent(pathWithoutToken); // Decode 'audios/uid/filename.mp4'

                    const fileRef = ref(storage, decodedPath);
                    await deleteObject(fileRef);
                    showMessage('‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏à‡∏≤‡∏Å Storage ‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } catch (storageError) {
                    console.warn("Could not delete file from Storage (potential permissions issue or file not found in expected path):", storageError.message);
                    showMessage(`‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Storage ‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${storageError.message}) ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ï‡∏≤‡πÉ‡∏ô Firestore ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö`, 'warning');
                }

                // Delete document from Firestore 'submissions_part1'
                await deleteDoc(doc(db, 'submissions_part1', docId));

                showMessage('‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                await fetchSubmissionPart1Files(); // Refresh the list
                searchResultsContainer.innerHTML = ''; // Clear search results after deletion
                noSearchResultsMessage.classList.remove('hidden');
            } catch (error) {
                console.error("Error deleting file:", error);
                showMessage(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Function to search for audio files
        async function searchAudio() {
            if (!isAuthReady || !currentUserId) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                return;
            }

            const searchEmail = searchEmailInput.value.toLowerCase().trim();
            const searchDateStr = searchDateInput.value; // YYYY-MM-DD format

            if (!searchEmail && !searchDateStr) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô E-mail ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'warning');
                return;
            }

            showLoading();
            let filteredFiles = allSubmissionFiles;

            // Filter by Email
            if (searchEmail) {
                filteredFiles = filteredFiles.filter(file => {
                    const email = file.data.email ? file.data.email.toLowerCase() : '';
                    return email.includes(searchEmail);
                });
            }

            // Filter by Date
            if (searchDateStr) {
                const searchDate = new Date(searchDateStr); // This is the start of the day in local time
                const searchDateStart = new Date(searchDate.getFullYear(), searchDate.getMonth(), searchDate.getDate(), 0, 0, 0, 0);
                const searchDateEnd = new Date(searchDate.getFullYear(), searchDate.getMonth(), searchDate.getDate(), 23, 59, 59, 999);

                filteredFiles = filteredFiles.filter(file => {
                    if (file.data.timestamp && file.data.timestamp.toDate) {
                        const fileTimestamp = file.data.timestamp.toDate();
                        return fileTimestamp >= searchDateStart && fileTimestamp <= searchDateEnd;
                    }
                    return false;
                });
            }

            renderFiles(searchResultsContainer, filteredFiles, noSearchResultsMessage);
            hideLoading();
        }

        // Event Listeners
        searchButton.addEventListener('click', searchAudio);

        // Event delegation for delete buttons in 'submissions_part1' section
        submissionPart1FilesContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-submission-btn')) {
                const docId = event.target.dataset.docId;
                const audioUrl = event.target.dataset.audioUrl;
                deleteSubmissionPart1File(docId, audioUrl);
            }
        });

        // Initialize Firebase on window load
        window.onload = initializeFirebase;

    </script>
</body>
</html>
